{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-4"><i class="bi bi-broadcast"></i> Análisis en Vivo</h2>
    
    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Control de Monitoreo</h5>
                </div>
                <div class="card-body">
                    <p>Monitorea Firebase y predice automáticamente cuando se agregan nuevos valores.</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" id="startBtn" onclick="startMonitoring()">
                            <i class="bi bi-play-circle"></i> Iniciar Monitoreo
                        </button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopMonitoring()" disabled>
                            <i class="bi bi-stop-circle"></i> Detener Monitoreo
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <div id="statusBadge" class="badge bg-secondary w-100 p-2">
                            <i class="bi bi-circle-fill"></i> Detenido
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Datos Actuales Firebase</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Temperatura</label>
                        <h3 class="text-danger mb-0" id="currentTemp">--°C</h3>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Humedad Ambiental</label>
                        <h3 class="text-primary mb-0" id="currentHum">--%</h3>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">MOI (Lógica Difusa)</label>
                        <h3 class="text-success mb-0" id="currentMoi">--</h3>
                        <small class="text-muted" id="currentMoiCat">--</small>
                    </div>
                    <div>
                        <label class="text-muted small">Última actualización</label>
                        <p id="currentTime" class="small mb-0">--</p>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Parámetros de Predicción</h5>
                    <span id="paramsStatus" class="badge bg-success">
                        <i class="bi bi-check-circle-fill"></i> Activo
                    </span>
                </div>
                <div class="card-body">
                    <!-- Alert de confirmación de cambios -->
                    <div id="changeAlert" class="alert alert-info alert-dismissible fade" role="alert" style="display: none;">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Parámetros actualizados</strong>
                        <p class="mb-0 small">Las predicciones ahora usan la nueva configuración</p>
                    </div>
                    
                    <form id="liveForm">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">
                                <i class="bi bi-flower1"></i> Tipo de Cultivo
                            </label>
                            <select class="form-select form-select-sm" name="crop_id" id="liveCrop" onchange="onParamsChange()">
                                <option value="Wheat" selected>Wheat</option>
                                <option value="Chilli">Chilli</option>
                                <option value="Potato">Potato</option>
                                <option value="Carrot">Carrot</option>
                                <option value="Tomato">Tomato</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">
                                <i class="bi bi-layers-fill"></i> Tipo de Suelo
                            </label>
                            <select class="form-select form-select-sm" name="soil_type" id="liveSoil" onchange="onParamsChange()">
                                <option value="Black Soil" selected>Black Soil</option>
                                <option value="Clay Soil">Clay Soil</option>
                                <option value="Sandy Soil">Sandy Soil</option>
                                <option value="Red Soil">Red Soil</option>
                                <option value="Loam Soil">Loam Soil</option>
                                <option value="Alluvial Soil">Alluvial Soil</option>
                                <option value="Chalky Soil">Chalky Soil</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">
                                <i class="bi bi-graph-up-arrow"></i> Etapa de Desarrollo
                            </label>
                            <select class="form-select form-select-sm" name="seedling_stage" id="liveStage" onchange="onParamsChange()">
                                <option value="Germination">Germination</option>
                                <option value="Seedling Stage">Seedling Stage</option>
                                <option value="Vegetative Growth / Root or Tuber Development">Vegetative Growth</option>
                                <option value="Flowering" selected>Flowering</option>
                                <option value="Pollination">Pollination</option>
                                <option value="Fruit/Grain/Bulb Formation">Fruit Formation</option>
                                <option value="Maturation">Maturation</option>
                                <option value="Harvest">Harvest</option>
                            </select>
                        </div>

                        <!-- Indicador de configuración actual -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <p class="small text-muted mb-2 fw-bold">
                                <i class="bi bi-gear-fill"></i> Configuración Actual:
                            </p>
                            <div class="small">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Cultivo:</span>
                                    <span class="fw-bold" id="currentCropDisplay">Wheat</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Suelo:</span>
                                    <span class="fw-bold" id="currentSoilDisplay">Black Soil</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Etapa:</span>
                                    <span class="fw-bold" id="currentStageDisplay">Flowering</span>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-sm w-100 mt-3" id="applyBtn" onclick="applyParameters()" disabled>
                            <i class="bi bi-arrow-clockwise"></i> Aplicar Cambios
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Predicciones en Tiempo Real</h5>
                    <span class="badge bg-light text-dark" id="predictionCounter">
                        0 predicciones
                    </span>
                </div>
                <div class="card-body">
                    <div id="predictionsContainer"></div>
                    <div id="noPredictions" class="text-center text-muted py-5">
                        <i class="bi bi-inbox display-1"></i>
                        <p class="mt-3">Inicia el monitoreo para ver predicciones automáticas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let monitoring = false;
let predictions = [];
let currentData = {};
let paramsChanged = false;

// Estado de los parámetros
let currentParams = {
    crop: 'Wheat',
    soil: 'Black Soil',
    stage: 'Flowering'
};

function onParamsChange() {
    const newCrop = document.getElementById('liveCrop').value;
    const newSoil = document.getElementById('liveSoil').value;
    const newStage = document.getElementById('liveStage').value;
    
    // Verificar si hay cambios
    if (newCrop !== currentParams.crop || 
        newSoil !== currentParams.soil || 
        newStage !== currentParams.stage) {
        paramsChanged = true;
        document.getElementById('applyBtn').disabled = false;
        document.getElementById('applyBtn').classList.add('btn-warning');
        document.getElementById('applyBtn').classList.remove('btn-primary');
        document.getElementById('applyBtn').innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Aplicar Cambios Pendientes';
        
        // Cambiar badge de estado
        document.getElementById('paramsStatus').className = 'badge bg-warning text-dark';
        document.getElementById('paramsStatus').innerHTML = '<i class="bi bi-clock-fill"></i> Pendiente';
    }
}

function applyParameters() {
    // Actualizar parámetros actuales
    currentParams.crop = document.getElementById('liveCrop').value;
    currentParams.soil = document.getElementById('liveSoil').value;
    currentParams.stage = document.getElementById('liveStage').value;
    
    // Actualizar displays
    document.getElementById('currentCropDisplay').textContent = currentParams.crop;
    document.getElementById('currentSoilDisplay').textContent = currentParams.soil;
    document.getElementById('currentStageDisplay').textContent = currentParams.stage;
    
    // Resetear estado
    paramsChanged = false;
    document.getElementById('applyBtn').disabled = true;
    document.getElementById('applyBtn').classList.remove('btn-warning');
    document.getElementById('applyBtn').classList.add('btn-primary');
    document.getElementById('applyBtn').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Aplicar Cambios';
    
    // Actualizar badge de estado
    document.getElementById('paramsStatus').className = 'badge bg-success';
    document.getElementById('paramsStatus').innerHTML = '<i class="bi bi-check-circle-fill"></i> Activo';
    
    // Mostrar alerta de confirmación
    const alert = document.getElementById('changeAlert');
    alert.style.display = 'block';
    alert.classList.add('show');
    
    // Ocultar alerta después de 3 segundos
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => {
            alert.style.display = 'none';
        }, 150);
    }, 3000);
    
    // Limpiar predicciones anteriores para mostrar las nuevas
    predictions = [];
    renderPredictions();
}

async function startMonitoring() {
    await fetch('/api/start-monitoring', {method: 'POST'});
    monitoring = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('statusBadge').className = 'badge bg-success w-100 p-2';
    document.getElementById('statusBadge').innerHTML = '<i class="bi bi-circle-fill"></i> Activo';
    
    pollData();
}

async function stopMonitoring() {
    await fetch('/api/stop-monitoring', {method: 'POST'});
    monitoring = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('statusBadge').className = 'badge bg-secondary w-100 p-2';
    document.getElementById('statusBadge').innerHTML = '<i class="bi bi-circle-fill"></i> Detenido';
}

async function pollData() {
    if (!monitoring) return;
    
    const latestResponse = await fetch('/api/latest-firebase');
    const latest = await latestResponse.json();
    
    if (latest.temperatura) {
        currentData = latest;
        document.getElementById('currentTemp').textContent = latest.temperatura + '°C';
        document.getElementById('currentHum').textContent = latest.humedad + '%';
        document.getElementById('currentMoi').textContent = latest.moi.toFixed(1);
        document.getElementById('currentMoiCat').textContent = latest.moi_category;
        document.getElementById('currentTime').textContent = latest.timestamp;
    }
    
    const predResponse = await fetch('/api/last-prediction');
    const pred = await predResponse.json();
    
    if (pred.timestamp && !predictions.find(p => p.timestamp === pred.timestamp)) {
        predictions.unshift(pred);
        predictions = predictions.slice(0, 10);
        renderPredictions();
    }
    
    setTimeout(pollData, 2000);
}

function renderPredictions() {
    const counter = document.getElementById('predictionCounter');
    counter.textContent = predictions.length + ' predicción' + (predictions.length !== 1 ? 'es' : '');
    
    if (predictions.length === 0) {
        document.getElementById('noPredictions').style.display = 'block';
        document.getElementById('predictionsContainer').style.display = 'none';
        return;
    }
    
    document.getElementById('noPredictions').style.display = 'none';
    document.getElementById('predictionsContainer').style.display = 'block';
    
    let html = '';
    predictions.forEach((p, index) => {
        const badgeClass = p.prediction === 'Requiere Riego' ? 'success' : 'danger';
        const icon = p.prediction === 'Requiere Riego' ? 'droplet-fill' : 'x-circle-fill';
        const isLatest = index === 0;
        
        html += `
            <div class="alert alert-${badgeClass} alert-dismissible fade show ${isLatest ? 'border border-3 border-dark' : ''}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <i class="bi bi-${icon}"></i>
                        <strong>${p.prediction}</strong> ${isLatest ? '<span class="badge bg-dark ms-2">NUEVA</span>' : ''}
                        <span class="ms-2">Confianza: ${(p.confidence*100).toFixed(2)}%</span>
                        <br>
                        <small>Temp: ${p.temperatura}°C | Hum: ${p.humedad}% | MOI: ${p.moi.toFixed(1)} (${p.moi_category})</small>
                        <br>
                        <small class="text-muted"><i class="bi bi-clock"></i> ${p.timestamp}</small>
                        <br>
                        <small class="badge bg-secondary mt-1">
                            <i class="bi bi-gear"></i> ${p.crop_id || currentParams.crop} | ${p.soil_type || currentParams.soil} | ${p.seedling_stage || currentParams.stage}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('predictionsContainer').innerHTML = html;
}

async function updateLatest() {
    if (monitoring) return;
    
    const response = await fetch('/api/latest-firebase');
    const latest = await response.json();
    
    if (latest.temperatura) {
        document.getElementById('currentTemp').textContent = latest.temperatura + '°C';
        document.getElementById('currentHum').textContent = latest.humedad + '%';
        document.getElementById('currentMoi').textContent = latest.moi.toFixed(1);
        document.getElementById('currentMoiCat').textContent = latest.moi_category;
        document.getElementById('currentTime').textContent = latest.timestamp;
    }
}

updateLatest();
setInterval(updateLatest, 3000);
</script>
{% endblock %}